<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Svenska Travbanor â€“ Dagens tÃ¤vlingar</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#0b3d91" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* Tooltips â€“ medelstor text */
    .leaflet-tooltip {
      font-size: 18px !important;
      font-weight: 600 !important;
      padding: 6px 10px !important;
      line-height: 1.3 !important;
      background-color: white;
      border: 1px solid #444 !important;
    }

    /* Popup-text â€“ medelstor */
    .leaflet-popup-content {
      font-size: 18px !important;
      line-height: 1.5 !important;
    }

    .leaflet-popup-content b {
      font-size: 20px !important;
    }

    .weather-icon {
      width: 24px !important;
      height: 24px !important;
      vertical-align: middle;
    }

    @media (max-width: 600px) {
      .leaflet-tooltip {
        font-size: 19px !important;
      }
      .leaflet-popup-content {
        font-size: 19px !important;
      }
      .leaflet-popup-content b {
        font-size: 21px !important;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ========= HJÃ„LPFUNKTIONER =========

    // Lokal datumstrÃ¤ng YYYY-MM-DD (inte UTC)
    function getTodayISO() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function weatherDescription(code) {
      const table = {
        0: "Klart",
        1: "Mest klart",
        2: "Halvklart",
        3: "Mulet",
        45: "Dimma",
        48: "Dimma med rimfrost",
        51: "LÃ¤tt duggregn",
        53: "Duggregn",
        55: "Tungt duggregn",
        61: "LÃ¤tt regn",
        63: "Regn",
        65: "Kraftigt regn",
        71: "LÃ¤tt snÃ¶fall",
        73: "SnÃ¶fall",
        75: "Kraftigt snÃ¶fall",
        80: "LÃ¤tta skurar",
        81: "Skurar",
        82: "Kraftiga skurar",
        95: "Ã…ska",
        96: "Ã…ska + lÃ¤tt hagel",
        99: "Ã…ska + kraftigt hagel"
      };
      return table[code] || "OkÃ¤nt vÃ¤der";
    }

    function weatherIcon(code) {
      if (code === 0) return "â˜€ï¸";
      if ([1, 2].includes(code)) return "ðŸŒ¤ï¸";
      if (code === 3) return "â˜ï¸";
      if ([45, 48].includes(code)) return "ðŸŒ«ï¸";
      if ([51, 53, 55, 61, 63, 65].includes(code)) return "ðŸŒ§ï¸";
      if ([71, 73, 75].includes(code)) return "ðŸŒ¨ï¸";
      if ([80, 81, 82].includes(code)) return "ðŸŒ¦ï¸";
      if ([95, 96, 99].includes(code)) return "â›ˆï¸";
      return "â“";
    }

    // ========= KARTA =========
    const map = L.map("map").setView([62.0, 15.0], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // ========= ALLA 33 TRAVBANOR =========
    const allTracks = [
      // Norra / mellersta Norrland
      { name: "BergsÃ¥ker",               lat: 62.4158, lon: 17.2165 },
      { name: "Dannero",                 lat: 63.0198, lon: 17.7932 },
      { name: "SolÃ¤nget",                lat: 63.291,  lon: 18.72 },
      { name: "Hoting",                  lat: 64.105,  lon: 16.189 },
      { name: "SkellefteÃ¥",              lat: 64.751,  lon: 20.95 },
      { name: "UmÃ¥ker",                  lat: 63.8102, lon: 20.1949 },
      { name: "Lycksele",                lat: 64.595,  lon: 18.676 },
      { name: "Haparanda",               lat: 65.838,  lon: 24.127 },
      { name: "Ã–stersund",               lat: 63.179,  lon: 14.66 },
      { name: "Oviken",                  lat: 62.995,  lon: 14.443 },
      { name: "Ã…sele",                   lat: 64.162,  lon: 17.347 },

      // Mellansverige
      { name: "BollnÃ¤s",                 lat: 61.3417, lon: 16.3351 },
      { name: "Hagmyren",                lat: 61.732,  lon: 16.807 },
      { name: "GÃ¤vle",                   lat: 60.6903, lon: 17.1342 },
      { name: "RÃ¤ttvik",                 lat: 60.883,  lon: 15.134 },
      { name: "Romme",                   lat: 60.474,  lon: 15.437 },
      { name: "Lindesberg",              lat: 59.602,  lon: 15.236 },
      { name: "Ã–rebro",                  lat: 59.303,  lon: 15.206 },

      // MÃ¤lardalen / runt Stockholm
      { name: "Solvalla",                lat: 59.3668, lon: 17.9462 },
      { name: "Eskilstuna (Sundbyholm)", lat: 59.4386, lon: 16.6143 },
      { name: "Mantorp",                 lat: 58.347,  lon: 15.287 },

      // VÃ¤stra / sydvÃ¤stra Sverige
      { name: "Ã…by",                     lat: 57.6495, lon: 12.0033 },
      { name: "Ã…mÃ¥l",                    lat: 59.051,  lon: 12.708 },
      { name: "Ã…rjÃ¤ng",                  lat: 59.392,  lon: 12.135 },
      { name: "FÃ¤rjestad",               lat: 59.4091, lon: 13.5035 },
      { name: "Karlshamn",               lat: 56.171,  lon: 14.867 },
      { name: "Vaggeryd",                lat: 57.5,    lon: 14.14 },

      // SÃ¶dra / sydÃ¶stra Sverige
      { name: "Halmstad",                lat: 56.6927, lon: 12.9259 },
      { name: "JÃ¤gersro",                lat: 55.5735, lon: 13.0624 },
      { name: "Kalmar",                  lat: 56.700,  lon: 16.308 },
      { name: "Tingsryd",                lat: 56.529,  lon: 14.976 },
      { name: "Visby",                   lat: 57.634,  lon: 18.307 }
    ];

    const markers = [];

    // ========= HÃ„MTA VÃ„DER + 6H PROGNOS =========
    function fetchWeatherFor(track, marker) {
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${track.lat}` +
        `&longitude=${track.lon}` +
        `&current_weather=true` +
        `&hourly=temperature_2m,weathercode` +
        `&forecast_days=1` +
        `&temperature_unit=celsius`;

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data || !data.current_weather || !data.hourly) return;

          const tempNow = data.current_weather.temperature;
          const codeNow = data.current_weather.weathercode;
          const iconNow = weatherIcon(codeNow);
          const descNow = weatherDescription(codeNow);

          const now = new Date(data.current_weather.time);
          const times = data.hourly.time;
          const temps = data.hourly.temperature_2m;
          const codes = data.hourly.weathercode;

          let startIndex = 0;
          for (let i = 0; i < times.length; i++) {
            if (new Date(times[i]) > now) {
              startIndex = i;
              break;
            }
          }

          const nextHours = [];
          for (let i = 0; i < 6; i++) {
            const idx = startIndex + i;
            if (idx < times.length && temps[idx] != null) {
              nextHours.push({
                time: times[idx].slice(11, 16),
                temp: temps[idx],
                icon: weatherIcon(codes[idx])
              });
            }
          }

          // Uppdatera tooltip
          const tt = marker.getTooltip();
          if (tt) {
            tt.setContent(
              `${track.name}: start ${track.firstStart}, ` +
              `${tempNow.toFixed(1)} Â°C ${iconNow}`
            );
          }

          // Bygg popup
          let forecastHTML = "<b>NÃ¤sta 6 timmar:</b><br>";
          nextHours.forEach(h => {
            forecastHTML += `${h.time}: ${h.temp.toFixed(1)} Â°C ${h.icon}<br>`;
          });

          const popupHtml =
            `<b>${track.name}</b><br>` +
            `FÃ¶rsta start: ${track.firstStart}<br>` +
            `Nu: ${tempNow.toFixed(1)} Â°C ${iconNow} â€“ ${descNow}<br><br>` +
            forecastHTML;

          marker.setPopupContent(popupHtml);
        })
        .catch(err => {
          console.log("Weather fetch failed for", track.name, err);
        });
    }

    // ========= SKAPA MARKÃ–RER FÃ–R DAGENS BANOR =========
    function buildMarkersForToday(schedule) {
      const today = getTodayISO();

      // Filtrera fram alla starter idag
      const todaysEntries = schedule.filter(e => e.date === today);

      // Bygg tabell trackName -> tidigaste firstStart
      const byTrack = {};
      todaysEntries.forEach(e => {
        const name = e.trackName;
        const time = e.firstStart;
        if (!byTrack[name] || time < byTrack[name]) {
          byTrack[name] = time;
        }
      });

      const todaysTracks = allTracks
        .filter(track => byTrack[track.name])
        .map(track => ({
          ...track,
          firstStart: byTrack[track.name]
        }));

      // Inga tÃ¤vlingar idag?
      if (todaysTracks.length === 0) {
        alert("Inga tÃ¤vlingar idag enligt schedule.json");
        return;
      }

      todaysTracks.forEach(track => {
        const marker = L.marker([track.lat, track.lon]).addTo(map);
        markers.push({ track, marker });

        // Grund-tooltip och popup
        marker.bindTooltip(
          `${track.name}: start ${track.firstStart}, laddar vÃ¤der...`,
          { permanent: true, direction: "top", offset: [0, -10] }
        ).openTooltip();

        marker.bindPopup(
          `<b>${track.name}</b><br>` +
          `FÃ¶rsta start: ${track.firstStart}<br>` +
          `Laddar vÃ¤der...`
        );

        marker.on("click", () => marker.openPopup());

        // HÃ¤mta vÃ¤der
        fetchWeatherFor(track, marker);
      });
    }

    // ========= LADDA Ã…RSSCHEMA FRÃ…N schedule.json =========
    fetch("schedule.json")
      .then(r => r.json())
      .then(schedule => {
        buildMarkersForToday(schedule);
        // Uppdatera vÃ¤der var 5:e minut
        setInterval(() => {
          markers.forEach(({ track, marker }) => fetchWeatherFor(track, marker));
        }, 5 * 60 * 1000);
      })
      .catch(err => {
        console.error("Kunde inte lÃ¤sa schedule.json", err);
        alert("Kunde inte lÃ¤sa schedule.json â€“ kontrollera filen.");
      });
  </script>

  <!-- PWA service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("./service-worker.js")
          .catch(function (error) {
            console.log("Service worker registration failed:", error);
          });
      });
    }
  </script>
</body>
</html>
